# Ansible Infrastructure Automation Project

This project uses Ansible to automate the setup of a complex infrastructure, including artifact repositories, databases, and Kubernetes clusters with Rancher management. A Vagrant environment is provided for testing and development.

## Prerequisites

*   [Vagrant](https://www.vagrantup.com/downloads)
*   [VirtualBox](https://www.virtualbox.org/wiki/Downloads) (Ensure a version compatible with your host OS and kernel is installed)
*   Ansible (installed on the machine you will use as the Ansible control node, e.g., your local machine or a WSL environment)

## Environment Setup with Vagrant

The `Vagrantfile` included in this project will define and provision the necessary virtual machines as specified in the `hosts` inventory file.

1.  **Start the Virtual Machines**:
    Navigate to the root directory of this project in your terminal and run:
    ```bash
    vagrant up
    ```
    This command will download the base VM images (if not already cached) and create all defined VMs (artefatos, dados, Kubernetes nodes, etc.). Each VM will be provisioned with Python 3 and Docker, which are prerequisites for the Ansible playbooks.

2.  **Configure SSH Keys for Ansible**:
    The Ansible `hosts` file is configured to use specific SSH private keys for each VM. These keys are generated by Vagrant. The `.vagrant/keys_cp.sh` script helps copy these keys to the locations expected by Ansible.

    *   **If Vagrant is running on Windows and your Ansible control node is Linux/WSL**:
        After `vagrant up` completes, from your Linux/WSL terminal (in the project root):
        ```bash
        bash .vagrant/keys_cp.sh
        ```
        This script copies the private keys from the default Windows Vagrant machine folders to the `./.vagrant/` directory in your project and renames them appropriately (e.g., `pgm_artefatos`). The `hosts` file is already configured to look for keys in this `./.vagrant/` relative path.

    *   **If Vagrant and Ansible are on the same Linux machine**:
        The `keys_cp.sh` script might need adjustment as it assumes a Windows host for Vagrant key locations. Alternatively, you can manually copy the keys:
        For each VM (e.g., `artefatos`), the key is typically at `.vagrant/machines/artefatos/virtualbox/private_key`. You would copy this to `.vagrant/pgm_artefatos`.
        Or, modify the `hosts` file to point directly to Vagrant's default private key paths for each VM. (The current setup with `keys_cp.sh` and relative paths in `hosts` is designed for the Windows host -> Linux/WSL Ansible controller scenario).

3.  **Verify SSH Key Setup**:
    Ensure files like `.vagrant/pgm_artefatos`, `.vagrant/pgm_dados`, etc., exist in your project root after running `keys_cp.sh` or manual copying.

## Running Ansible Playbooks

Once the Vagrant VMs are up and SSH keys are configured:

1.  **Test Connectivity (Optional but Recommended)**:
    From your Ansible control node (in the project root):
    ```bash
    ansible -i hosts all -m ping
    ```
    You should see a "pong" response from all managed nodes.

2.  **Run the Main Playbook**:
    To deploy and configure all services:
    ```bash
    ansible-playbook -i hosts play_all.yml
    ```

## Troubleshooting

*   **VirtualBox Kernel Module Issues**: If `vagrant up` fails with errors related to VirtualBox kernel modules (`vboxdrv`), ensure VirtualBox is correctly installed for your host OS kernel. This might involve reinstalling VirtualBox, running `sudo /sbin/vboxconfig` (on Linux), or ensuring secure boot is not interfering.
*   **Ansible SSH Errors**: If Ansible cannot connect, double-check that the private key files exist at the paths specified in the `hosts` file (`.vagrant/pgm_...`) and that they have correct permissions (usually `chmod 600 ./.vagrant/pgm_*`).
